<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Ledger</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{Ledger State Transition}

</a><a id="36" class="Markup">\begin{code}[hide]</a>
<a id="55" class="Symbol">{-#</a> <a id="59" class="Keyword">OPTIONS</a> <a id="67" class="Pragma">--safe</a> <a id="74" class="Symbol">#-}</a>

<a id="79" class="Keyword">open</a> <a id="84" class="Keyword">import</a> <a id="91" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a> <a id="110" class="Keyword">using</a> <a id="116" class="Symbol">(</a><a id="117" href="Ledger.Transaction.html#549" class="Record">TransactionStructure</a><a id="137" class="Symbol">)</a>

<a id="140" class="Keyword">module</a> <a id="147" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="161" class="Symbol">(</a><a id="162" href="Ledger.Ledger.html#162" class="Bound">txs</a> <a id="166" class="Symbol">:</a> <a id="168" href="Ledger.Transaction.html#549" class="Record">TransactionStructure</a><a id="188" class="Symbol">)</a> <a id="190" class="Keyword">where</a>

<a id="197" class="Keyword">open</a> <a id="202" class="Keyword">import</a> <a id="209" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a>

<a id="225" class="Keyword">open</a> <a id="230" href="Ledger.Transaction.html#549" class="Module">TransactionStructure</a> <a id="251" href="Ledger.Ledger.html#162" class="Bound">txs</a>
<a id="255" class="Keyword">open</a> <a id="260" class="Keyword">import</a> <a id="267" href="Ledger.PParams.html" class="Module">Ledger.PParams</a> <a id="282" href="Ledger.Transaction.html#1517" class="Field">epochStructure</a>

<a id="298" class="Keyword">open</a> <a id="303" class="Keyword">import</a> <a id="310" href="Ledger.PPUp.html" class="Module">Ledger.PPUp</a> <a id="322" href="Ledger.Ledger.html#162" class="Bound">txs</a>
<a id="326" class="Keyword">open</a> <a id="331" class="Keyword">import</a> <a id="338" href="Ledger.Gov.html" class="Module">Ledger.Gov</a> <a id="349" href="Ledger.Transaction.html#1454" class="Field">TxId</a> <a id="354" href="Ledger.Epoch.html#337" class="Function">Network</a> <a id="362" href="Ledger.Transaction.html#2476" class="Function">ADHash</a> <a id="369" href="Ledger.Transaction.html#1517" class="Field">epochStructure</a> <a id="384" href="Ledger.Transaction.html#1958" class="Field">ppUpd</a> <a id="390" href="Ledger.Transaction.html#1858" class="Field">ppHashingScheme</a> <a id="406" href="Ledger.Transaction.html#1731" class="Field">crypto</a>
<a id="413" class="Keyword">open</a> <a id="418" class="Keyword">import</a> <a id="425" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="437" href="Ledger.Ledger.html#162" class="Bound">txs</a>
<a id="441" class="Keyword">open</a> <a id="446" class="Keyword">import</a> <a id="453" href="Ledger.Utxow.html" class="Module">Ledger.Utxow</a> <a id="466" href="Ledger.Ledger.html#162" class="Bound">txs</a>

<a id="471" class="Keyword">import</a> <a id="478" href="Data.List.html" class="Module">Data.List</a> <a id="488" class="Symbol">as</a> <a id="491" class="Module">L</a>

<a id="494" class="Keyword">open</a> <a id="499" href="Ledger.Transaction.html#4273" class="Module">Tx</a>
<a id="502" class="Keyword">open</a> <a id="507" href="Ledger.Transaction.html#3640" class="Module">TxBody</a>
<a id="514" class="Markup">\end{code}</a><a id="524" class="Background">

The entire state transformation of the ledger state caused by a valid
transaction can now be given as a combination of the previously
defined transition systems.

\begin{figure*}[h]
</a><a id="708" class="Markup">\begin{code}</a>
<a id="721" class="Keyword">record</a> <a id="LEnv"></a><a id="728" href="Ledger.Ledger.html#728" class="Record">LEnv</a> <a id="733" class="Symbol">:</a> <a id="735" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="739" class="Keyword">where</a>
  <a id="747" class="Keyword">constructor</a> <a id="⟦_,_⟧ˡᵉ"></a><a id="759" href="Ledger.Ledger.html#759" class="InductiveConstructor Operator">⟦_,_⟧ˡᵉ</a>
  <a id="769" class="Keyword">field</a> <a id="LEnv.slot"></a><a id="775" href="Ledger.Ledger.html#775" class="Field">slot</a>     <a id="784" class="Symbol">:</a> <a id="786" href="Ledger.Epoch.html#608" class="Function">Slot</a>
        <a id="LEnv.pparams"></a><a id="799" href="Ledger.Ledger.html#799" class="Field">pparams</a>  <a id="808" class="Symbol">:</a> <a id="810" href="Ledger.PParams.html#1053" class="Record">PParams</a>

<a id="819" class="Keyword">record</a> <a id="LState"></a><a id="826" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="833" class="Symbol">:</a> <a id="835" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="839" class="Keyword">where</a>
  <a id="847" class="Keyword">constructor</a> <a id="⟦_,_,_⟧ˡ"></a><a id="859" href="Ledger.Ledger.html#859" class="InductiveConstructor Operator">⟦_,_,_⟧ˡ</a>
  <a id="870" class="Keyword">field</a> <a id="LState.utxoSt"></a><a id="876" href="Ledger.Ledger.html#876" class="Field">utxoSt</a>     <a id="887" class="Symbol">:</a> <a id="889" href="Ledger.Utxo.html#4757" class="Record">UTxOState</a>
        <a id="LState.govSt"></a><a id="907" href="Ledger.Ledger.html#907" class="Field">govSt</a>      <a id="918" class="Symbol">:</a> <a id="920" href="Ledger.Gov.html#1005" class="Function">GovState</a>
        <a id="LState.certState"></a><a id="937" href="Ledger.Ledger.html#937" class="Field">certState</a>  <a id="948" class="Symbol">:</a> <a id="950" href="Ledger.Deleg.html#2170" class="Record">CertState</a>

<a id="txgov"></a><a id="961" href="Ledger.Ledger.html#961" class="Function">txgov</a> <a id="967" class="Symbol">:</a> <a id="969" href="Ledger.Transaction.html#3640" class="Record">TxBody</a> <a id="976" class="Symbol">→</a> <a id="978" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="983" class="Symbol">(</a><a id="984" href="Ledger.GovernanceActions.html#9101" class="Record">GovVote</a> <a id="992" href="Data.Sum.Base.html#616" class="Datatype Operator">⊎</a> <a id="994" href="Ledger.GovernanceActions.html#9288" class="Record">GovProposal</a><a id="1005" class="Symbol">)</a>
<a id="1007" href="Ledger.Ledger.html#961" class="Function">txgov</a> <a id="1013" href="Ledger.Ledger.html#1013" class="Bound">txb</a> <a id="1017" class="Symbol">=</a> <a id="1019" href="Data.List.Base.html#1606" class="Function">L.map</a> <a id="1025" href="Data.Sum.Base.html#666" class="InductiveConstructor">inj₁</a> <a id="1030" class="Symbol">(</a><a id="1031" href="Ledger.Transaction.html#3906" class="Field">txvote</a> <a id="1038" href="Ledger.Ledger.html#1013" class="Bound">txb</a><a id="1041" class="Symbol">)</a> <a id="1043" href="Data.List.Base.html#1929" class="Function Operator">++</a> <a id="1046" href="Data.List.Base.html#1606" class="Function">L.map</a> <a id="1052" href="Data.Sum.Base.html#691" class="InductiveConstructor">inj₂</a> <a id="1057" class="Symbol">(</a><a id="1058" href="Ledger.Transaction.html#3943" class="Field">txprop</a> <a id="1065" href="Ledger.Ledger.html#1013" class="Bound">txb</a><a id="1068" class="Symbol">)</a>
<a id="1070" class="Markup">\end{code}</a><a id="1080" class="Background">
\caption{Types and functions for the LEDGER transition system}
\end{figure*}
</a><a id="1158" class="Markup">\begin{code}[hide]</a>
<a id="1177" class="Keyword">private</a> <a id="1185" class="Keyword">variable</a>
  <a id="1196" href="Ledger.Ledger.html#1196" class="Generalizable">Γ</a> <a id="1198" class="Symbol">:</a> <a id="1200" href="Ledger.Ledger.html#728" class="Record">LEnv</a>
  <a id="1207" href="Ledger.Ledger.html#1207" class="Generalizable">s</a> <a id="1209" href="Ledger.Ledger.html#1209" class="Generalizable">s&#39;</a> <a id="1212" href="Ledger.Ledger.html#1212" class="Generalizable">s&#39;&#39;</a> <a id="1216" class="Symbol">:</a> <a id="1218" href="Ledger.Ledger.html#826" class="Record">LState</a>
  <a id="1227" href="Ledger.Ledger.html#1227" class="Generalizable">utxoSt&#39;</a> <a id="1235" class="Symbol">:</a> <a id="1237" href="Ledger.Utxo.html#4757" class="Record">UTxOState</a>
  <a id="1249" href="Ledger.Ledger.html#1249" class="Generalizable">govSt&#39;</a> <a id="1256" class="Symbol">:</a> <a id="1258" href="Ledger.Gov.html#1005" class="Function">GovState</a>
  <a id="1269" href="Ledger.Ledger.html#1269" class="Generalizable">certState&#39;</a> <a id="1280" class="Symbol">:</a> <a id="1282" href="Ledger.Deleg.html#2170" class="Record">CertState</a>
  <a id="1294" href="Ledger.Ledger.html#1294" class="Generalizable">tx</a> <a id="1297" class="Symbol">:</a> <a id="1299" href="Ledger.Transaction.html#4273" class="Record">Tx</a>
<a id="1302" class="Markup">\end{code}</a><a id="1312" class="Background">

\begin{figure*}[h]
</a><a id="1333" class="Markup">\begin{code}[hide]</a>
<a id="1352" class="Keyword">open</a> <a id="1357" href="Ledger.Address.html#1243" class="Module">RwdAddr</a>
<a id="1365" class="Keyword">open</a> <a id="1370" href="Ledger.Deleg.html#1587" class="Module">DState</a>
<a id="1377" class="Keyword">open</a> <a id="1382" href="Ledger.Deleg.html#2170" class="Module">CertState</a>

<a id="1393" class="Keyword">data</a>
<a id="1398" class="Markup">\end{code}</a><a id="1408" class="Background">
</a><a id="1409" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,LEDGER⦈_"></a><a id="1424" href="Ledger.Ledger.html#1424" class="Datatype Operator">_⊢_⇀⦇_,LEDGER⦈_</a> <a id="1440" class="Symbol">:</a> <a id="1442" href="Ledger.Ledger.html#728" class="Record">LEnv</a> <a id="1447" class="Symbol">→</a> <a id="1449" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="1456" class="Symbol">→</a> <a id="1458" href="Ledger.Transaction.html#4273" class="Record">Tx</a> <a id="1461" class="Symbol">→</a> <a id="1463" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="1470" class="Symbol">→</a> <a id="1472" href="Agda.Primitive.html#320" class="Primitive">Set</a>
<a id="1476" class="Markup">\end{code}</a><a id="1486" class="Background">
</a><a id="1487" class="Markup">\begin{code}[hide]</a>
  <a id="1508" class="Keyword">where</a>
<a id="1514" class="Markup">\end{code}</a><a id="1524" class="Background">
\caption{The type of the LEDGER transition system}
\end{figure*}

\begin{figure*}[h]
</a><a id="1610" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,LEDGER⦈_.LEDGER"></a><a id="1625" href="Ledger.Ledger.html#1625" class="InductiveConstructor">LEDGER</a> <a id="1632" class="Symbol">:</a> <a id="1634" class="Keyword">let</a> <a id="1638" class="Keyword">open</a> <a id="1643" href="Ledger.Ledger.html#826" class="Module">LState</a> <a id="1650" href="Ledger.Ledger.html#1207" class="Generalizable">s</a><a id="1651" class="Symbol">;</a> <a id="1653" href="Ledger.Ledger.html#1653" class="Bound">txb</a> <a id="1657" class="Symbol">=</a> <a id="1659" href="Ledger.Transaction.html#4298" class="Field">body</a> <a id="1664" href="Ledger.Ledger.html#1294" class="Generalizable">tx</a><a id="1666" class="Symbol">;</a> <a id="1668" class="Keyword">open</a> <a id="1673" href="Ledger.Ledger.html#728" class="Module">LEnv</a> <a id="1678" href="Ledger.Ledger.html#1196" class="Generalizable">Γ</a> <a id="1680" class="Keyword">in</a>
    <a id="1687" class="Keyword">record</a> <a id="1694" class="Symbol">{</a> <a id="1696" href="Ledger.Ledger.html#1696" class="Module">LEnv</a> <a id="1701" href="Ledger.Ledger.html#1196" class="Generalizable">Γ</a> <a id="1703" class="Symbol">}</a> <a id="1705" href="Ledger.Utxow.html#1185" class="Datatype Operator">⊢</a> <a id="1707" href="Ledger.Ledger.html#876" class="Function">utxoSt</a> <a id="1714" href="Ledger.Utxow.html#1185" class="Datatype Operator">⇀⦇</a> <a id="1717" href="Ledger.Ledger.html#1294" class="Generalizable">tx</a> <a id="1720" href="Ledger.Utxow.html#1185" class="Datatype Operator">,UTXOW⦈</a> <a id="1728" href="Ledger.Ledger.html#1227" class="Generalizable">utxoSt&#39;</a>
    <a id="1740" class="Symbol">→</a> <a id="1742" href="Ledger.Deleg.html#1425" class="InductiveConstructor Operator">⟦</a> <a id="1744" href="Ledger.Epoch.html#647" class="Function">epoch</a> <a id="1750" href="Ledger.Ledger.html#775" class="Function">slot</a> <a id="1755" href="Ledger.Deleg.html#1425" class="InductiveConstructor Operator">,</a> <a id="1757" href="Ledger.Ledger.html#799" class="Function">pparams</a> <a id="1765" href="Ledger.Deleg.html#1425" class="InductiveConstructor Operator">,</a> <a id="1767" href="Ledger.Transaction.html#3906" class="Field">txvote</a> <a id="1774" href="Ledger.Ledger.html#1653" class="Bound">txb</a> <a id="1778" href="Ledger.Deleg.html#1425" class="InductiveConstructor Operator">⟧ᶜ</a> <a id="1781" href="Ledger.Deleg.html#5987" class="Function Operator">⊢</a> <a id="1783" href="Ledger.Ledger.html#937" class="Function">certState</a> <a id="1793" href="Ledger.Deleg.html#5987" class="Function Operator">⇀⦇</a> <a id="1796" href="Ledger.Transaction.html#3842" class="Field">txcerts</a> <a id="1804" href="Ledger.Ledger.html#1653" class="Bound">txb</a> <a id="1808" href="Ledger.Deleg.html#5987" class="Function Operator">,CERTS⦈</a> <a id="1816" href="Ledger.Ledger.html#1269" class="Generalizable">certState&#39;</a>
    <a id="1831" class="Symbol">→</a> <a id="1833" href="Ledger.Gov.html#1108" class="InductiveConstructor Operator">⟦</a> <a id="1835" href="Ledger.Transaction.html#4148" class="Field">txid</a> <a id="1840" href="Ledger.Ledger.html#1653" class="Bound">txb</a> <a id="1844" href="Ledger.Gov.html#1108" class="InductiveConstructor Operator">,</a> <a id="1846" href="Ledger.Epoch.html#647" class="Function">epoch</a> <a id="1852" href="Ledger.Ledger.html#775" class="Function">slot</a> <a id="1857" href="Ledger.Gov.html#1108" class="InductiveConstructor Operator">,</a> <a id="1859" href="Ledger.Ledger.html#799" class="Function">pparams</a> <a id="1867" href="Ledger.Gov.html#1108" class="InductiveConstructor Operator">⟧ᵗ</a> <a id="1870" href="Ledger.Gov.html#3048" class="Function Operator">⊢</a> <a id="1872" href="Ledger.Ledger.html#907" class="Function">govSt</a> <a id="1878" href="Ledger.Gov.html#3048" class="Function Operator">⇀⦇</a> <a id="1881" href="Ledger.Ledger.html#961" class="Function">txgov</a> <a id="1887" href="Ledger.Ledger.html#1653" class="Bound">txb</a> <a id="1891" href="Ledger.Gov.html#3048" class="Function Operator">,GOV⦈</a> <a id="1897" href="Ledger.Ledger.html#1249" class="Generalizable">govSt&#39;</a>
    <a id="1908" class="Symbol">→</a> <a id="1910" href="Axiom.Set.html#4924" class="Function">map</a> <a id="1914" href="Ledger.Address.html#1296" class="Field">stake</a> <a id="1920" class="Symbol">(</a><a id="1921" href="Axiom.Set.Rel.html#1551" class="Function">dom</a> <a id="1925" class="Symbol">(</a><a id="1926" href="Ledger.Transaction.html#3877" class="Field">txwdrls</a> <a id="1934" href="Ledger.Ledger.html#1653" class="Bound">txb</a> <a id="1938" href="Axiom.Set.Map.html#2261" class="Function Operator">ˢ</a><a id="1939" class="Symbol">))</a> <a id="1942" href="Axiom.Set.html#1889" class="Function Operator">⊆</a> <a id="1944" href="Axiom.Set.Rel.html#1551" class="Function">dom</a> <a id="1948" class="Symbol">(</a><a id="1949" href="Ledger.Deleg.html#1638" class="Field">voteDelegs</a> <a id="1960" class="Symbol">(</a><a id="1961" href="Ledger.Deleg.html#2200" class="Field">dState</a> <a id="1968" href="Ledger.Ledger.html#1269" class="Generalizable">certState&#39;</a><a id="1978" class="Symbol">)</a> <a id="1980" href="Axiom.Set.Map.html#2261" class="Function Operator">ˢ</a><a id="1981" class="Symbol">)</a>
    <a id="1987" href="Interface.STS.html#211" class="Function Operator">────────────────────────────────</a>
    <a id="2024" href="Ledger.Ledger.html#1196" class="Generalizable">Γ</a> <a id="2026" href="Ledger.Ledger.html#1424" class="Datatype Operator">⊢</a> <a id="2028" href="Ledger.Ledger.html#1207" class="Generalizable">s</a> <a id="2030" href="Ledger.Ledger.html#1424" class="Datatype Operator">⇀⦇</a> <a id="2033" href="Ledger.Ledger.html#1294" class="Generalizable">tx</a> <a id="2036" href="Ledger.Ledger.html#1424" class="Datatype Operator">,LEDGER⦈</a> <a id="2045" href="Ledger.Ledger.html#859" class="InductiveConstructor Operator">⟦</a> <a id="2047" href="Ledger.Ledger.html#1227" class="Generalizable">utxoSt&#39;</a> <a id="2055" href="Ledger.Ledger.html#859" class="InductiveConstructor Operator">,</a> <a id="2057" href="Ledger.Ledger.html#1249" class="Generalizable">govSt&#39;</a> <a id="2064" href="Ledger.Ledger.html#859" class="InductiveConstructor Operator">,</a> <a id="2066" href="Ledger.Ledger.html#1269" class="Generalizable">certState&#39;</a> <a id="2077" href="Ledger.Ledger.html#859" class="InductiveConstructor Operator">⟧ˡ</a>
<a id="2080" class="Markup">\end{code}</a><a id="2090" class="Background">
\caption{LEDGER transition system}
\end{figure*}
\begin{figure*}[h]
</a><a id="2159" class="Markup">\begin{code}</a>
<a id="_⊢_⇀⦇_,LEDGERS⦈_"></a><a id="2172" href="Ledger.Ledger.html#2172" class="Function Operator">_⊢_⇀⦇_,LEDGERS⦈_</a> <a id="2189" class="Symbol">:</a> <a id="2191" href="Ledger.Ledger.html#728" class="Record">LEnv</a> <a id="2196" class="Symbol">→</a> <a id="2198" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="2205" class="Symbol">→</a> <a id="2207" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="2212" href="Ledger.Transaction.html#4273" class="Record">Tx</a> <a id="2215" class="Symbol">→</a> <a id="2217" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="2224" class="Symbol">→</a> <a id="2226" href="Agda.Primitive.html#320" class="Primitive">Set</a>
<a id="2230" href="Ledger.Ledger.html#2172" class="Function Operator">_⊢_⇀⦇_,LEDGERS⦈_</a> <a id="2247" class="Symbol">=</a> <a id="2249" href="Interface.STS.html#966" class="Function">SS⇒BS</a> <a id="2255" class="Symbol">(λ</a> <a id="2258" class="Keyword">where</a> <a id="2264" class="Symbol">(</a><a id="2265" href="Ledger.Ledger.html#2265" class="Bound">Γ</a> <a id="2267" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2269" class="Symbol">_)</a> <a id="2272" class="Symbol">→</a> <a id="2274" href="Ledger.Ledger.html#2265" class="Bound">Γ</a> <a id="2276" href="Ledger.Ledger.html#1424" class="Datatype Operator">⊢_⇀⦇_,LEDGER⦈_</a><a id="2290" class="Symbol">)</a>
<a id="2292" class="Markup">\end{code}</a><a id="2302" class="Background">
\caption{LEDGERS transition system}
\end{figure*}
</a></pre></body></html>