<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Chain</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{Blockchain layer}

</a><a id="29" class="Markup">\begin{code}[hide]</a>
<a id="48" class="Symbol">{-#</a> <a id="52" class="Keyword">OPTIONS</a> <a id="60" class="Pragma">--safe</a> <a id="67" class="Symbol">#-}</a>

<a id="72" class="Keyword">open</a> <a id="77" class="Keyword">import</a> <a id="84" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>

<a id="104" class="Keyword">module</a> <a id="111" href="Ledger.Chain.html" class="Module">Ledger.Chain</a> <a id="124" class="Symbol">(</a><a id="125" href="Ledger.Chain.html#125" class="Bound">txs</a> <a id="129" class="Symbol">:</a> <a id="131" href="Ledger.Transaction.html#549" class="Record">TransactionStructure</a><a id="151" class="Symbol">)</a> <a id="153" class="Keyword">where</a>

<a id="160" class="Keyword">open</a> <a id="165" class="Keyword">import</a> <a id="172" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a>

<a id="188" class="Keyword">open</a> <a id="193" class="Keyword">import</a> <a id="200" href="Algebra.html" class="Module">Algebra</a>

<a id="209" class="Keyword">open</a> <a id="214" href="Ledger.Transaction.html#549" class="Module">TransactionStructure</a> <a id="235" href="Ledger.Chain.html#125" class="Bound">txs</a>
<a id="239" class="Keyword">open</a> <a id="244" class="Keyword">import</a> <a id="251" href="Ledger.PParams.html" class="Module">Ledger.PParams</a> <a id="266" href="Ledger.Transaction.html#1517" class="Field">epochStructure</a>
<a id="281" class="Keyword">open</a> <a id="286" class="Keyword">import</a> <a id="293" href="Ledger.NewPP.html" class="Module">Ledger.NewPP</a> <a id="306" href="Ledger.Chain.html#125" class="Bound">txs</a>
<a id="310" class="Keyword">open</a> <a id="315" class="Keyword">import</a> <a id="322" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="336" href="Ledger.Chain.html#125" class="Bound">txs</a>
<a id="340" class="Keyword">open</a> <a id="345" class="Keyword">import</a> <a id="352" href="Ledger.PPUp.html" class="Module">Ledger.PPUp</a> <a id="364" href="Ledger.Chain.html#125" class="Bound">txs</a>
<a id="368" class="Keyword">open</a> <a id="373" class="Keyword">import</a> <a id="380" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="392" href="Ledger.Chain.html#125" class="Bound">txs</a>
<a id="396" class="Keyword">open</a> <a id="401" class="Keyword">import</a> <a id="408" href="Ledger.Ratify.html" class="Module">Ledger.Ratify</a> <a id="422" href="Ledger.Chain.html#125" class="Bound">txs</a>
<a id="426" class="Keyword">open</a> <a id="431" class="Keyword">import</a> <a id="438" href="Ledger.Gov.html" class="Module">Ledger.Gov</a> <a id="449" href="Ledger.Transaction.html#1454" class="Field">TxId</a> <a id="454" href="Ledger.Epoch.html#337" class="Function">Network</a> <a id="462" href="Ledger.Transaction.html#2476" class="Function">ADHash</a> <a id="469" href="Ledger.Transaction.html#1517" class="Field">epochStructure</a> <a id="484" href="Ledger.Transaction.html#1958" class="Field">ppUpd</a> <a id="490" href="Ledger.Transaction.html#1858" class="Field">ppHashingScheme</a> <a id="506" href="Ledger.Transaction.html#1731" class="Field">crypto</a>
<a id="513" class="Keyword">open</a> <a id="518" href="Function.Bundles.html#4340" class="Module">Equivalence</a>
<a id="530" class="Keyword">open</a> <a id="535" class="Keyword">import</a> <a id="542" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="562" class="Keyword">using</a> <a id="568" class="Symbol">(</a><a id="569" href="Data.Nat.Properties.html#16387" class="Function">+-0-monoid</a><a id="579" class="Symbol">)</a>
<a id="581" class="Keyword">open</a> <a id="586" class="Keyword">import</a> <a id="593" href="Data.Maybe.Base.html" class="Module">Data.Maybe.Base</a> <a id="609" class="Keyword">using</a> <a id="615" class="Symbol">(</a><a id="616" href="Data.Maybe.Base.html#2242" class="Function Operator">_&gt;&gt;=_</a><a id="621" class="Symbol">)</a> <a id="623" class="Keyword">renaming</a> <a id="632" class="Symbol">(</a><a id="633" href="Data.Maybe.Base.html#2035" class="Function">map</a> <a id="637" class="Symbol">to</a> <a id="640" class="Function">map?</a><a id="644" class="Symbol">)</a>

<a id="647" class="Markup">\end{code}</a><a id="657" class="Background">
\begin{figure*}[h]
</a><a id="677" class="Markup">\begin{code}</a>

<a id="691" class="Keyword">record</a> <a id="NewEpochEnv"></a><a id="698" href="Ledger.Chain.html#698" class="Record">NewEpochEnv</a> <a id="710" class="Symbol">:</a> <a id="712" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="716" class="Keyword">where</a>
  <a id="724" class="Keyword">field</a> <a id="NewEpochEnv.stakeDistrs"></a><a id="730" href="Ledger.Chain.html#730" class="Field">stakeDistrs</a>  <a id="743" class="Symbol">:</a> <a id="745" href="Ledger.Ratify.html#4924" class="Record">StakeDistrs</a> <a id="757" class="Comment">-- TODO: compute this from LState instead</a>

<a id="800" class="Keyword">record</a> <a id="NewEpochState"></a><a id="807" href="Ledger.Chain.html#807" class="Record">NewEpochState</a> <a id="821" class="Symbol">:</a> <a id="823" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="827" class="Keyword">where</a>
  <a id="835" class="Keyword">constructor</a> <a id="⟦_,_,_,_,_⟧ⁿᵉ"></a><a id="847" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧ⁿᵉ</a>
  <a id="863" class="Keyword">field</a> <a id="NewEpochState.lastEpoch"></a><a id="869" href="Ledger.Chain.html#869" class="Field">lastEpoch</a>  <a id="880" class="Symbol">:</a> <a id="882" href="Ledger.Epoch.html#593" class="Function">Epoch</a>
        <a id="NewEpochState.acnt"></a><a id="896" href="Ledger.Chain.html#896" class="Field">acnt</a>       <a id="907" class="Symbol">:</a> <a id="909" href="Ledger.PParams.html#730" class="Record">Acnt</a>
        <a id="NewEpochState.ls"></a><a id="922" href="Ledger.Chain.html#922" class="Field">ls</a>         <a id="933" class="Symbol">:</a> <a id="935" href="Ledger.Ledger.html#826" class="Record">LState</a>
        <a id="NewEpochState.es"></a><a id="950" href="Ledger.Chain.html#950" class="Field">es</a> <a id="NewEpochState.esFut"></a><a id="953" href="Ledger.Chain.html#953" class="Field">esFut</a>   <a id="961" class="Symbol">:</a> <a id="963" href="Ledger.GovernanceActions.html#13326" class="Record">EnactState</a>

<a id="975" class="Keyword">record</a> <a id="ChainState"></a><a id="982" href="Ledger.Chain.html#982" class="Record">ChainState</a> <a id="993" class="Symbol">:</a> <a id="995" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="999" class="Keyword">where</a>
  <a id="1007" class="Keyword">field</a> <a id="ChainState.newEpochState"></a><a id="1013" href="Ledger.Chain.html#1013" class="Field">newEpochState</a>  <a id="1028" class="Symbol">:</a> <a id="1030" href="Ledger.Chain.html#807" class="Record">NewEpochState</a>

<a id="1045" class="Keyword">record</a> <a id="Block"></a><a id="1052" href="Ledger.Chain.html#1052" class="Record">Block</a> <a id="1058" class="Symbol">:</a> <a id="1060" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="1064" class="Keyword">where</a>
  <a id="1072" class="Keyword">field</a> <a id="Block.ts"></a><a id="1078" href="Ledger.Chain.html#1078" class="Field">ts</a>    <a id="1084" class="Symbol">:</a> <a id="1086" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="1091" href="Ledger.Transaction.html#4273" class="Record">Tx</a>
        <a id="Block.slot"></a><a id="1102" href="Ledger.Chain.html#1102" class="Field">slot</a>  <a id="1108" class="Symbol">:</a> <a id="1110" href="Ledger.Epoch.html#608" class="Function">Slot</a>

<a id="1116" class="Keyword">instance</a>
  <a id="1127" href="Ledger.Chain.html#1127" class="Function">_</a> <a id="1129" class="Symbol">=</a> <a id="1131" href="Data.Nat.Properties.html#16387" class="Function">+-0-monoid</a>
<a id="1142" class="Markup">\end{code}</a><a id="1152" class="Background">
\caption{Definitions for the NEWEPOCH and CHAIN transition systems}
\end{figure*}
</a><a id="1235" class="Markup">\begin{code}[hide]</a>
<a id="1254" class="Keyword">private</a> <a id="1262" class="Keyword">variable</a>
  <a id="1273" href="Ledger.Chain.html#1273" class="Generalizable">s</a> <a id="1275" class="Symbol">:</a> <a id="1277" href="Ledger.Chain.html#982" class="Record">ChainState</a>
  <a id="1290" href="Ledger.Chain.html#1290" class="Generalizable">b</a> <a id="1292" class="Symbol">:</a> <a id="1294" href="Ledger.Chain.html#1052" class="Record">Block</a>
  <a id="1302" href="Ledger.Chain.html#1302" class="Generalizable">ls&#39;</a> <a id="1306" class="Symbol">:</a> <a id="1308" href="Ledger.Ledger.html#826" class="Record">LState</a>
  <a id="1317" href="Ledger.Chain.html#1317" class="Generalizable">pparams&#39;</a> <a id="1326" class="Symbol">:</a> <a id="1328" href="Ledger.PParams.html#1053" class="Record">PParams</a>
  <a id="1338" href="Ledger.Chain.html#1338" class="Generalizable">ppup</a> <a id="1343" href="Ledger.Chain.html#1343" class="Generalizable">ppup&#39;</a> <a id="1349" class="Symbol">:</a> <a id="1351" href="Ledger.PPUp.html#814" class="Record">PPUpdateState</a>
  <a id="1367" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="1371" class="Symbol">:</a> <a id="1373" href="Ledger.Chain.html#807" class="Record">NewEpochState</a>
  <a id="1389" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="1391" class="Symbol">:</a> <a id="1393" href="Ledger.Epoch.html#593" class="Function">Epoch</a>
  <a id="1401" href="Ledger.Chain.html#1401" class="Generalizable">es&#39;</a> <a id="1405" class="Symbol">:</a> <a id="1407" href="Ledger.GovernanceActions.html#13326" class="Record">EnactState</a>
  <a id="1420" href="Ledger.Chain.html#1420" class="Generalizable">govSt&#39;</a> <a id="1427" class="Symbol">:</a> <a id="1429" href="Ledger.Gov.html#1005" class="Function">GovState</a>
  <a id="1440" href="Ledger.Chain.html#1440" class="Generalizable">removed</a> <a id="1448" class="Symbol">:</a> <a id="1450" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="1455" class="Symbol">(</a><a id="1456" href="Ledger.GovernanceActions.html#1435" class="Function">GovActionID</a> <a id="1468" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="1470" href="Ledger.Gov.html#796" class="Record">GovActionState</a><a id="1484" class="Symbol">)</a>
  <a id="1488" href="Ledger.Chain.html#1488" class="Generalizable">d</a> <a id="1490" class="Symbol">:</a> <a id="1492" href="Agda.Builtin.Bool.html#156" class="Datatype">Bool</a>

<a id="1498" class="Comment">-- The NEWEPOCH rule is actually multiple rules in one for the sake of simplicity:</a>
<a id="1581" class="Comment">-- it also does what EPOCH used to do in previous eras</a>
<a id="1636" class="Keyword">data</a> <a id="_⊢_⇀⦇_,NEWEPOCH⦈_"></a><a id="1641" href="Ledger.Chain.html#1641" class="Datatype Operator">_⊢_⇀⦇_,NEWEPOCH⦈_</a> <a id="1659" class="Symbol">:</a> <a id="1661" href="Ledger.Chain.html#698" class="Record">NewEpochEnv</a> <a id="1673" class="Symbol">→</a> <a id="1675" href="Ledger.Chain.html#807" class="Record">NewEpochState</a> <a id="1689" class="Symbol">→</a> <a id="1691" href="Ledger.Epoch.html#593" class="Function">Epoch</a> <a id="1697" class="Symbol">→</a> <a id="1699" href="Ledger.Chain.html#807" class="Record">NewEpochState</a> <a id="1713" class="Symbol">→</a> <a id="1715" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="1719" class="Keyword">where</a>
<a id="1725" class="Markup">\end{code}</a><a id="1735" class="Background">
\begin{figure*}[h]
</a><a id="1755" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-New"></a><a id="1770" href="Ledger.Chain.html#1770" class="InductiveConstructor">NEWEPOCH-New</a> <a id="1783" class="Symbol">:</a> <a id="1785" class="Symbol">∀</a> <a id="1787" class="Symbol">{</a><a id="1788" href="Ledger.Chain.html#1788" class="Bound">Γ</a><a id="1789" class="Symbol">}</a> <a id="1791" class="Symbol">→</a> <a id="1793" class="Keyword">let</a>
      <a id="1803" class="Keyword">open</a> <a id="1808" href="Ledger.Chain.html#807" class="Module">NewEpochState</a> <a id="1822" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="1826" class="Keyword">hiding</a> <a id="1833" class="Symbol">(</a><a id="1834" href="Ledger.Chain.html#950" class="Field">es</a><a id="1836" class="Symbol">)</a> <a id="1838" class="Keyword">renaming</a> <a id="1847" class="Symbol">(</a><a id="1848" href="Ledger.Chain.html#953" class="Field">esFut</a> <a id="1854" class="Symbol">to</a> <a id="1857" class="Field">es</a><a id="1859" class="Symbol">)</a> <a id="1861" class="Comment">-- this rolls over esFut into es</a>
      <a id="1900" class="Keyword">open</a> <a id="1905" href="Ledger.Ledger.html#826" class="Module">LState</a> <a id="1912" href="Ledger.Chain.html#922" class="Function">ls</a>
      <a id="1921" class="Comment">-- TODO Wire CertState together with treasury and withdrawals</a>
      <a id="1989" class="Keyword">open</a> <a id="1994" href="Ledger.Deleg.html#2170" class="Module">CertState</a> <a id="2004" href="Ledger.Ledger.html#937" class="Function">certState</a>
      <a id="2020" class="Keyword">open</a> <a id="2025" href="Ledger.Deleg.html#1867" class="Module">PState</a> <a id="2032" href="Ledger.Deleg.html#2224" class="Function">pState</a>
      <a id="2045" href="Ledger.Chain.html#2045" class="Bound">removedGovActions</a> <a id="2063" class="Symbol">=</a> <a id="2065" href="Axiom.Set.html#4924" class="Function">map</a> <a id="2069" href="Ledger.Utxo.html#2616" class="InductiveConstructor">GovActionDeposit</a> <a id="2086" class="Symbol">(</a><a id="2087" href="Axiom.Set.html#4924" class="Function">map</a> <a id="2091" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="2097" class="Symbol">(</a><a id="2098" href="Axiom.Set.html#5564" class="Function">fromList</a> <a id="2107" href="Ledger.Chain.html#1440" class="Generalizable">removed</a><a id="2114" class="Symbol">))</a>
      <a id="2123" href="Ledger.Chain.html#2123" class="Bound">pup</a> <a id="2127" class="Symbol">=</a> <a id="2129" href="Ledger.PPUp.html#848" class="Field">PPUpdateState.pup</a> <a id="2147" href="Ledger.Chain.html#1338" class="Generalizable">ppup</a>
      <a id="2158" href="Ledger.Chain.html#2158" class="Bound">deposits</a> <a id="2167" class="Symbol">=</a> <a id="2169" href="Ledger.Utxo.html#4864" class="Field">UTxOState.deposits</a> <a id="2188" href="Ledger.Ledger.html#876" class="Function">utxoSt</a>
      <a id="2201" href="Ledger.Chain.html#2201" class="Bound">retired</a> <a id="2209" class="Symbol">=</a> <a id="2211" href="Ledger.Deleg.html#1959" class="Function">retiring</a> <a id="2220" href="Axiom.Set.Map.html#10378" class="Function Operator">⁻¹</a> <a id="2223" href="Ledger.Chain.html#1389" class="Generalizable">e</a>
      <a id="2231" href="Ledger.Chain.html#2231" class="Bound">govActionReturns&#39;</a> <a id="2249" class="Symbol">=</a> <a id="2251" href="Axiom.Set.html#6857" class="Function">concatMapˢ</a>
        <a id="2270" class="Symbol">(λ</a> <a id="2273" class="Keyword">where</a>
          <a id="2289" class="Symbol">(</a><a id="2290" href="Ledger.Chain.html#2290" class="Bound">gaid</a> <a id="2295" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2297" href="Ledger.Chain.html#2297" class="Bound">gaSt</a><a id="2301" class="Symbol">)</a> <a id="2303" class="Symbol">→</a> <a id="2305" href="Axiom.Set.html#4924" class="Function">map</a>
            <a id="2321" class="Symbol">(</a><a id="2322" href="Ledger.Gov.html#883" class="Field">GovActionState.returnAddr</a> <a id="2348" href="Ledger.Chain.html#2297" class="Bound">gaSt</a> <a id="2353" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,_</a><a id="2355" class="Symbol">)</a>
            <a id="2369" class="Symbol">((</a><a id="2371" href="Ledger.Chain.html#2158" class="Bound">deposits</a> <a id="2380" href="Axiom.Set.Map.html#2261" class="Function Operator">ˢ</a><a id="2381" class="Symbol">)</a> <a id="2383" href="Axiom.Set.Rel.html#4564" class="Function Operator">⟪$⟫</a> <a id="2387" href="Axiom.Set.html#6070" class="Function Operator">❴</a> <a id="2389" href="Ledger.Utxo.html#2616" class="InductiveConstructor">GovActionDeposit</a> <a id="2406" href="Ledger.Chain.html#2290" class="Bound">gaid</a> <a id="2411" href="Axiom.Set.html#6070" class="Function Operator">❵</a><a id="2412" class="Symbol">)</a>
        <a id="2422" class="Symbol">)</a>
        <a id="2432" class="Symbol">(</a><a id="2433" href="Axiom.Set.html#5564" class="Function">fromList</a> <a id="2442" href="Ledger.Chain.html#1440" class="Generalizable">removed</a><a id="2449" class="Symbol">)</a>
      <a id="2457" href="Ledger.Chain.html#2457" class="Bound">govActionReturns</a> <a id="2474" class="Symbol">=</a> <a id="2476" href="Axiom.Set.Map.Dec.html#2044" class="Function">aggregate₊</a> <a id="2487" class="Symbol">(</a><a id="2488" href="Ledger.Chain.html#2231" class="Bound">govActionReturns&#39;</a> <a id="2506" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2508" href="Ledger.Prelude.html#1753" class="Function">finiteness</a> <a id="2519" href="Ledger.Chain.html#2231" class="Bound">govActionReturns&#39;</a><a id="2536" class="Symbol">)</a>
      <a id="2544" href="Ledger.Chain.html#2544" class="Bound">rewards</a> <a id="2552" class="Symbol">=</a> <a id="2554" href="Ledger.Deleg.html#1826" class="Field">DState.rewards</a> <a id="2569" href="Ledger.Deleg.html#2200" class="Function">dState</a>
      <a id="2582" href="Ledger.Chain.html#2582" class="Bound">refunds</a>   <a id="2592" class="Symbol">=</a> <a id="2594" href="Ledger.Chain.html#2457" class="Bound">govActionReturns</a> <a id="2611" href="Axiom.Set.Map.html#8412" class="Function Operator">∣</a> <a id="2613" href="Axiom.Set.Rel.html#1551" class="Function">dom</a> <a id="2617" class="Symbol">(</a><a id="2618" href="Ledger.Chain.html#2544" class="Bound">rewards</a> <a id="2626" href="Axiom.Set.Map.html#2261" class="Function Operator">ˢ</a><a id="2627" class="Symbol">)</a>
      <a id="2635" href="Ledger.Chain.html#2635" class="Bound">unclaimed</a> <a id="2645" class="Symbol">=</a> <a id="2647" href="Ledger.Chain.html#2457" class="Bound">govActionReturns</a> <a id="2664" href="Axiom.Set.Map.html#8482" class="Function Operator">∣</a> <a id="2666" href="Axiom.Set.Rel.html#1551" class="Function">dom</a> <a id="2670" class="Symbol">(</a><a id="2671" href="Ledger.Chain.html#2544" class="Bound">rewards</a> <a id="2679" href="Axiom.Set.Map.html#2261" class="Function Operator">ˢ</a><a id="2680" class="Symbol">)</a> <a id="2682" href="Axiom.Set.Map.html#8482" class="Function Operator">ᶜ</a>
      <a id="2690" href="Ledger.Chain.html#2690" class="Bound">certState&#39;</a> <a id="2701" class="Symbol">=</a> <a id="2703" class="Keyword">record</a> <a id="2710" href="Ledger.Ledger.html#937" class="Function">certState</a> <a id="2720" class="Symbol">{</a>
        <a id="2730" href="Ledger.Deleg.html#2224" class="Field">pState</a> <a id="2737" class="Symbol">=</a> <a id="2739" class="Keyword">record</a> <a id="2746" href="Ledger.Deleg.html#2224" class="Function">pState</a> <a id="2753" class="Symbol">{</a> <a id="2755" href="Ledger.Deleg.html#1915" class="Field">pools</a> <a id="2761" class="Symbol">=</a> <a id="2763" href="Ledger.Deleg.html#1915" class="Function">pools</a> <a id="2769" href="Axiom.Set.Map.html#8482" class="Function Operator">∣</a> <a id="2771" href="Ledger.Chain.html#2201" class="Bound">retired</a> <a id="2779" href="Axiom.Set.Map.html#8482" class="Function Operator">ᶜ</a> <a id="2781" class="Symbol">;</a> <a id="2783" href="Ledger.Deleg.html#1959" class="Field">retiring</a> <a id="2792" class="Symbol">=</a> <a id="2794" href="Ledger.Deleg.html#1959" class="Function">retiring</a> <a id="2803" href="Axiom.Set.Map.html#8482" class="Function Operator">∣</a> <a id="2805" href="Ledger.Chain.html#2201" class="Bound">retired</a> <a id="2813" href="Axiom.Set.Map.html#8482" class="Function Operator">ᶜ</a> <a id="2815" class="Symbol">};</a>
        <a id="2826" href="Ledger.Deleg.html#2200" class="Field">dState</a> <a id="2833" class="Symbol">=</a> <a id="2835" class="Keyword">record</a> <a id="2842" href="Ledger.Deleg.html#2200" class="Function">dState</a> <a id="2849" class="Symbol">{</a> <a id="2851" href="Ledger.Deleg.html#1826" class="Field">rewards</a> <a id="2859" class="Symbol">=</a> <a id="2861" href="Ledger.Chain.html#2544" class="Bound">rewards</a> <a id="2869" href="Axiom.Set.Map.Dec.html#1962" class="Function Operator">∪⁺</a> <a id="2872" href="Ledger.Chain.html#2582" class="Bound">refunds</a> <a id="2880" class="Symbol">}</a> <a id="2882" class="Symbol">}</a>
      <a id="2890" href="Ledger.Chain.html#2890" class="Bound">utxoSt&#39;</a> <a id="2898" class="Symbol">=</a> <a id="2900" class="Keyword">record</a> <a id="2907" href="Ledger.Ledger.html#876" class="Function">utxoSt</a>
        <a id="2922" class="Symbol">{</a> <a id="2924" href="Ledger.Utxo.html#4838" class="Field">fees</a> <a id="2929" class="Symbol">=</a> <a id="2931" class="Number">0</a>
        <a id="2941" class="Symbol">;</a> <a id="2943" href="Ledger.Utxo.html#4864" class="Field">deposits</a> <a id="2952" class="Symbol">=</a> <a id="2954" href="Ledger.Chain.html#2158" class="Bound">deposits</a> <a id="2963" href="Axiom.Set.Map.html#8482" class="Function Operator">∣</a> <a id="2965" href="Ledger.Chain.html#2045" class="Bound">removedGovActions</a> <a id="2983" href="Axiom.Set.Map.html#8482" class="Function Operator">ᶜ</a>
        <a id="2993" class="Symbol">}</a>
      <a id="3001" href="Ledger.Chain.html#3001" class="Bound">ls&#39;</a> <a id="3005" class="Symbol">=</a> <a id="3007" class="Keyword">record</a> <a id="3014" href="Ledger.Chain.html#922" class="Function">ls</a> <a id="3017" class="Symbol">{</a> <a id="3019" href="Ledger.Ledger.html#907" class="Field">govSt</a> <a id="3025" class="Symbol">=</a> <a id="3027" href="Ledger.Chain.html#1420" class="Generalizable">govSt&#39;</a> <a id="3034" class="Symbol">;</a> <a id="3036" href="Ledger.Ledger.html#876" class="Field">utxoSt</a> <a id="3043" class="Symbol">=</a> <a id="3045" href="Ledger.Chain.html#2890" class="Bound">utxoSt&#39;</a> <a id="3053" class="Symbol">;</a> <a id="3055" href="Ledger.Ledger.html#937" class="Field">certState</a> <a id="3065" class="Symbol">=</a> <a id="3067" href="Ledger.Chain.html#2690" class="Bound">certState&#39;</a> <a id="3078" class="Symbol">}</a>
      <a id="3086" href="Ledger.Chain.html#3086" class="Bound">acnt&#39;</a> <a id="3092" class="Symbol">=</a> <a id="3094" class="Keyword">record</a> <a id="3101" href="Ledger.Chain.html#896" class="Function">acnt</a> <a id="3106" class="Symbol">{</a> <a id="3108" href="Ledger.PParams.html#755" class="Field">treasury</a> <a id="3117" class="Symbol">=</a> <a id="3119" href="Ledger.PParams.html#755" class="Field">Acnt.treasury</a> <a id="3133" href="Ledger.Chain.html#896" class="Function">acnt</a> <a id="3138" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="3140" href="Ledger.Utxo.html#4838" class="Field">UTxOState.fees</a> <a id="3155" href="Ledger.Ledger.html#876" class="Function">utxoSt</a> <a id="3162" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="3164" href="Ledger.Interface.HasCoin.html#170" class="Field">getCoin</a> <a id="3172" href="Ledger.Chain.html#2635" class="Bound">unclaimed</a> <a id="3182" class="Symbol">}</a>
    <a id="3188" class="Keyword">in</a>
    <a id="3195" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="3197" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="3199" href="Ledger.Epoch.html#820" class="Function">sucᵉ</a> <a id="3204" href="Ledger.Chain.html#869" class="Function">lastEpoch</a>
    <a id="3218" class="Symbol">→</a> <a id="3220" class="Keyword">record</a> <a id="3227" class="Symbol">{</a> <a id="3229" href="Ledger.Ratify.html#5058" class="Field">currentEpoch</a> <a id="3242" class="Symbol">=</a> <a id="3244" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="3246" class="Symbol">;</a> <a id="3248" href="Ledger.Chain.html#3248" class="Module">GState</a> <a id="3255" href="Ledger.Deleg.html#2248" class="Function">gState</a> <a id="3262" class="Symbol">;</a> <a id="3264" href="Ledger.Chain.html#3264" class="Module">NewEpochEnv</a> <a id="3276" href="Ledger.Chain.html#1788" class="Bound">Γ</a> <a id="3278" class="Symbol">}</a>
        <a id="3288" href="Ledger.Ratify.html#21112" class="Function Operator">⊢</a> <a id="3290" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">⟦</a> <a id="3292" href="Ledger.Chain.html#1857" class="Function">es</a>  <a id="3296" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">,</a> <a id="3298" href="Agda.Builtin.List.html#167" class="InductiveConstructor">[]</a> <a id="3301" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">,</a> <a id="3303" href="Agda.Builtin.List.html#167" class="InductiveConstructor">[]</a> <a id="3306" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">,</a> <a id="3308" href="Agda.Builtin.Bool.html#175" class="InductiveConstructor">false</a> <a id="3314" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">⟧ʳ</a> <a id="3317" href="Ledger.Ratify.html#21112" class="Function Operator">⇀⦇</a> <a id="3320" href="Ledger.Ledger.html#907" class="Function">govSt</a> <a id="3326" href="Ledger.Ratify.html#21112" class="Function Operator">,RATIFY⦈</a> <a id="3335" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">⟦</a> <a id="3337" href="Ledger.Chain.html#1401" class="Generalizable">es&#39;</a> <a id="3341" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">,</a> <a id="3343" href="Ledger.Chain.html#1420" class="Generalizable">govSt&#39;</a> <a id="3350" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">,</a> <a id="3352" href="Ledger.Chain.html#1440" class="Generalizable">removed</a> <a id="3360" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">,</a> <a id="3362" href="Ledger.Chain.html#1488" class="Generalizable">d</a> <a id="3364" href="Ledger.Ratify.html#5217" class="InductiveConstructor Operator">⟧ʳ</a>
    <a id="3371" class="Comment">-- TODO: remove keys that aren&#39;t in the CC from the hot key map</a>
    <a id="3439" href="Interface.STS.html#211" class="Function Operator">────────────────────────────────</a>
    <a id="3476" href="Ledger.Chain.html#1788" class="Bound">Γ</a> <a id="3478" href="Ledger.Chain.html#1641" class="Datatype Operator">⊢</a> <a id="3480" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="3484" href="Ledger.Chain.html#1641" class="Datatype Operator">⇀⦇</a> <a id="3487" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="3489" href="Ledger.Chain.html#1641" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="3500" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">⟦</a> <a id="3502" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="3504" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">,</a> <a id="3506" href="Ledger.Chain.html#3086" class="Bound">acnt&#39;</a> <a id="3512" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">,</a> <a id="3514" href="Ledger.Chain.html#3001" class="Bound">ls&#39;</a> <a id="3518" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">,</a> <a id="3520" href="Ledger.Chain.html#1857" class="Function">es</a> <a id="3523" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">,</a> <a id="3525" href="Ledger.Chain.html#1401" class="Generalizable">es&#39;</a> <a id="3529" href="Ledger.Chain.html#847" class="InductiveConstructor Operator">⟧ⁿᵉ</a>

  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-Not-New"></a><a id="3536" href="Ledger.Chain.html#3536" class="InductiveConstructor">NEWEPOCH-Not-New</a> <a id="3553" class="Symbol">:</a> <a id="3555" class="Symbol">∀</a> <a id="3557" class="Symbol">{</a><a id="3558" href="Ledger.Chain.html#3558" class="Bound">Γ</a><a id="3559" class="Symbol">}</a> <a id="3561" class="Symbol">→</a> <a id="3563" class="Keyword">let</a> <a id="3567" class="Keyword">open</a> <a id="3572" href="Ledger.Chain.html#807" class="Module">NewEpochState</a> <a id="3586" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="3590" class="Keyword">in</a>
    <a id="3597" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="3599" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="3601" href="Ledger.Epoch.html#820" class="Function">sucᵉ</a> <a id="3606" href="Ledger.Chain.html#869" class="Function">lastEpoch</a>
    <a id="3620" href="Interface.STS.html#211" class="Function Operator">────────────────────────────────</a>
    <a id="3657" href="Ledger.Chain.html#3558" class="Bound">Γ</a> <a id="3659" href="Ledger.Chain.html#1641" class="Datatype Operator">⊢</a> <a id="3661" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="3665" href="Ledger.Chain.html#1641" class="Datatype Operator">⇀⦇</a> <a id="3668" href="Ledger.Chain.html#1389" class="Generalizable">e</a> <a id="3670" href="Ledger.Chain.html#1641" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="3681" href="Ledger.Chain.html#1367" class="Generalizable">nes</a>
<a id="3685" class="Markup">\end{code}</a><a id="3695" class="Background">
\caption{NEWEPOCH transition system}
\end{figure*}

</a><a id="3748" class="Markup">\begin{code}[hide]</a>
<a id="maybePurpose"></a><a id="3767" href="Ledger.Chain.html#3767" class="Function">maybePurpose</a> <a id="3780" class="Symbol">:</a> <a id="3782" href="Ledger.Utxo.html#2431" class="Datatype">DepositPurpose</a> <a id="3797" class="Symbol">→</a> <a id="3799" class="Symbol">(</a><a id="3800" href="Ledger.Utxo.html#2431" class="Datatype">DepositPurpose</a> <a id="3815" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="3817" href="Ledger.Address.html#740" class="Function">Credential</a><a id="3827" class="Symbol">)</a> <a id="3829" class="Symbol">→</a> <a id="3831" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="3836" class="Symbol">→</a> <a id="3838" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="3844" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="3849" href="Ledger.Chain.html#3767" class="Function">maybePurpose</a> <a id="3862" href="Ledger.Chain.html#3862" class="Bound">prps</a> <a id="3867" class="Symbol">(</a><a id="3868" href="Ledger.Chain.html#3868" class="Bound">prps&#39;</a> <a id="3874" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="3876" class="Symbol">_)</a> <a id="3879" href="Ledger.Chain.html#3879" class="Bound">c</a> <a id="3881" class="Keyword">with</a> <a id="3886" href="Ledger.Chain.html#3862" class="Bound">prps</a> <a id="3891" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="3893" href="Ledger.Chain.html#3868" class="Bound">prps&#39;</a>
<a id="3899" class="Symbol">...</a> <a id="3903" class="Symbol">|</a> <a id="3905" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="3909" class="Symbol">_</a> <a id="3911" class="Symbol">=</a> <a id="3913" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="3918" class="Bound">c</a>
<a id="3920" class="Symbol">...</a> <a id="3924" class="Symbol">|</a> <a id="3926" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="3929" class="Symbol">_</a> <a id="3931" class="Symbol">=</a> <a id="3933" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a>

<a id="maybePurpose-prop"></a><a id="3942" href="Ledger.Chain.html#3942" class="Function">maybePurpose-prop</a> <a id="3960" class="Symbol">:</a> <a id="3962" class="Symbol">∀</a> <a id="3964" class="Symbol">{</a><a id="3965" href="Ledger.Chain.html#3965" class="Bound">prps</a><a id="3969" class="Symbol">}</a> <a id="3971" class="Symbol">{</a><a id="3972" href="Ledger.Chain.html#3972" class="Bound">x</a><a id="3973" class="Symbol">}</a> <a id="3975" class="Symbol">{</a><a id="3976" href="Ledger.Chain.html#3976" class="Bound">y</a><a id="3977" class="Symbol">}</a>
  <a id="3981" class="Symbol">→</a> <a id="3983" class="Symbol">(</a><a id="3984" href="Ledger.Chain.html#3984" class="Bound">m</a> <a id="3986" class="Symbol">:</a> <a id="3988" class="Symbol">(</a><a id="3989" href="Ledger.Utxo.html#2431" class="Datatype">DepositPurpose</a> <a id="4004" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="4006" href="Ledger.Address.html#740" class="Function">Credential</a><a id="4016" class="Symbol">)</a> <a id="4018" href="Ledger.Prelude.html#2585" class="Function Operator">⇀</a> <a id="4020" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="4024" class="Symbol">)</a>
  <a id="4028" class="Symbol">→</a> <a id="4030" class="Symbol">(</a><a id="4031" href="Ledger.Chain.html#3972" class="Bound">x</a> <a id="4033" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4035" href="Ledger.Chain.html#3976" class="Bound">y</a><a id="4036" class="Symbol">)</a> <a id="4038" href="Axiom.Set.html#1806" class="Function Operator">∈</a> <a id="4040" href="Axiom.Set.Rel.html#1551" class="Function">dom</a> <a id="4044" class="Symbol">((</a><a id="4046" href="Axiom.Set.Map.html#8160" class="Function">mapMaybeWithKeyᵐ</a> <a id="4063" class="Symbol">(</a><a id="4064" href="Ledger.Chain.html#3767" class="Function">maybePurpose</a> <a id="4077" href="Ledger.Chain.html#3965" class="Bound">prps</a><a id="4081" class="Symbol">)</a> <a id="4083" href="Ledger.Chain.html#3984" class="Bound">m</a><a id="4084" class="Symbol">)</a> <a id="4086" href="Axiom.Set.Map.html#2261" class="Function Operator">ˢ</a><a id="4087" class="Symbol">)</a>
  <a id="4091" class="Symbol">→</a> <a id="4093" href="Ledger.Chain.html#3972" class="Bound">x</a> <a id="4095" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="4097" href="Ledger.Chain.html#3965" class="Bound">prps</a>
<a id="4102" href="Ledger.Chain.html#3942" class="Function">maybePurpose-prop</a> <a id="4120" class="Symbol">{</a><a id="4121" class="Argument">prps</a> <a id="4126" class="Symbol">=</a> <a id="4128" href="Ledger.Chain.html#4128" class="Bound">prps</a><a id="4132" class="Symbol">}</a> <a id="4134" class="Symbol">{</a><a id="4135" href="Ledger.Chain.html#4135" class="Bound">x</a><a id="4136" class="Symbol">}</a> <a id="4138" class="Symbol">{</a><a id="4139" href="Ledger.Chain.html#4139" class="Bound">y</a><a id="4140" class="Symbol">}</a> <a id="4142" class="Symbol">_</a> <a id="4144" href="Ledger.Chain.html#4144" class="Bound">xy∈dom</a> <a id="4151" class="Keyword">with</a> <a id="4156" href="Function.Bundles.html#4398" class="Field">to</a> <a id="4159" href="Axiom.Set.Rel.html#2562" class="Function">dom∈</a> <a id="4164" href="Ledger.Chain.html#4144" class="Bound">xy∈dom</a>
<a id="4171" class="Symbol">...</a> <a id="4175" class="Symbol">|</a> <a id="4177" href="Ledger.Chain.html#4177" class="Bound">z</a> <a id="4179" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4181" href="Ledger.Chain.html#4181" class="Bound">∈mmwk</a> <a id="4187" class="Keyword">with</a> <a id="4192" class="Bound">prps</a> <a id="4197" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="4199" class="Bound">x</a> <a id="4201" class="Symbol">|</a> <a id="4203" href="Axiom.Set.Rel.html#4085" class="Function">∈-mapMaybeWithKey</a> <a id="4221" class="Symbol">{</a><a id="4222" class="Argument">f</a> <a id="4224" class="Symbol">=</a> <a id="4226" href="Ledger.Chain.html#3767" class="Function">maybePurpose</a> <a id="4239" class="Bound">prps</a><a id="4243" class="Symbol">}</a> <a id="4245" href="Ledger.Chain.html#4181" class="Bound">∈mmwk</a>
<a id="4251" class="Symbol">...</a> <a id="4255" class="Symbol">|</a> <a id="4257" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4261" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="4266" class="Symbol">|</a> <a id="4268" class="Symbol">_</a> <a id="4270" class="Symbol">=</a> <a id="4272" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a>

<a id="filterPurpose"></a><a id="4278" href="Ledger.Chain.html#4278" class="Function">filterPurpose</a> <a id="4292" class="Symbol">:</a> <a id="4294" href="Ledger.Utxo.html#2431" class="Datatype">DepositPurpose</a> <a id="4309" class="Symbol">→</a> <a id="4311" class="Symbol">(</a><a id="4312" href="Ledger.Utxo.html#2431" class="Datatype">DepositPurpose</a> <a id="4327" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="4329" href="Ledger.Address.html#740" class="Function">Credential</a><a id="4339" class="Symbol">)</a> <a id="4341" href="Ledger.Prelude.html#2585" class="Function Operator">⇀</a> <a id="4343" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="4348" class="Symbol">→</a> <a id="4350" href="Ledger.Address.html#740" class="Function">Credential</a> <a id="4361" href="Ledger.Prelude.html#2585" class="Function Operator">⇀</a> <a id="4363" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="4368" href="Ledger.Chain.html#4278" class="Function">filterPurpose</a> <a id="4382" href="Ledger.Chain.html#4382" class="Bound">prps</a> <a id="4387" href="Ledger.Chain.html#4387" class="Bound">m</a> <a id="4389" class="Symbol">=</a> <a id="4391" href="Axiom.Set.Map.html#6336" class="Function">mapKeys</a> <a id="4399" href="Data.Product.Base.html#622" class="Field">proj₂</a> <a id="4405" class="Symbol">(</a><a id="4406" href="Axiom.Set.Map.html#8160" class="Function">mapMaybeWithKeyᵐ</a> <a id="4423" class="Symbol">(</a><a id="4424" href="Ledger.Chain.html#3767" class="Function">maybePurpose</a> <a id="4437" href="Ledger.Chain.html#4382" class="Bound">prps</a><a id="4441" class="Symbol">)</a> <a id="4443" href="Ledger.Chain.html#4387" class="Bound">m</a><a id="4444" class="Symbol">)</a> <a id="4446" class="Symbol">λ</a> <a id="4448" class="Keyword">where</a>
  <a id="4456" class="Symbol">{</a><a id="4457" href="Ledger.Chain.html#4457" class="Bound">x</a> <a id="4459" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4461" class="DottedPattern Symbol">.</a><a id="4462" href="Ledger.Chain.html#4470" class="DottedPattern Bound">z</a><a id="4463" class="Symbol">}</a> <a id="4465" class="Symbol">{</a><a id="4466" href="Ledger.Chain.html#4466" class="Bound">y</a> <a id="4468" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4470" href="Ledger.Chain.html#4470" class="Bound">z</a><a id="4471" class="Symbol">}</a> <a id="4473" href="Ledger.Chain.html#4473" class="Bound">x∈dom</a> <a id="4479" href="Ledger.Chain.html#4479" class="Bound">y∈dom</a> <a id="4485" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="4490" class="Symbol">→</a> <a id="4492" href="Function.Base.html#4053" class="Function Operator">case</a> <a id="4497" href="Ledger.Chain.html#3942" class="Function">maybePurpose-prop</a> <a id="4515" class="Symbol">{</a><a id="4516" class="Argument">prps</a> <a id="4521" class="Symbol">=</a> <a id="4523" href="Ledger.Chain.html#4382" class="Bound">prps</a><a id="4527" class="Symbol">}</a> <a id="4529" href="Ledger.Chain.html#4387" class="Bound">m</a> <a id="4531" href="Ledger.Chain.html#4473" class="Bound">x∈dom</a> <a id="4537" href="Function.Base.html#4053" class="Function Operator">of</a> <a id="4540" class="Symbol">λ</a> <a id="4542" class="Keyword">where</a>
    <a id="4552" href="Ledger.Chain.html#4552" class="Bound">x≡prps</a> <a id="4559" class="Symbol">→</a> <a id="4561" href="Function.Base.html#4053" class="Function Operator">case</a> <a id="4566" href="Ledger.Chain.html#3942" class="Function">maybePurpose-prop</a> <a id="4584" class="Symbol">{</a><a id="4585" class="Argument">prps</a> <a id="4590" class="Symbol">=</a> <a id="4592" href="Ledger.Chain.html#4382" class="Bound">prps</a><a id="4596" class="Symbol">}</a> <a id="4598" href="Ledger.Chain.html#4387" class="Bound">m</a> <a id="4600" href="Ledger.Chain.html#4479" class="Bound">y∈dom</a> <a id="4606" href="Function.Base.html#4053" class="Function Operator">of</a> <a id="4609" class="Symbol">λ</a> <a id="4611" class="Keyword">where</a>
      <a id="4623" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="4628" class="Symbol">→</a> <a id="4630" href="Relation.Binary.PropositionalEquality.Core.html#1144" class="Function">cong</a> <a id="4635" class="Symbol">(</a><a id="4636" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">_,</a> <a id="4639" href="Ledger.Chain.html#4470" class="Bound">z</a><a id="4640" class="Symbol">)</a> <a id="4642" href="Ledger.Chain.html#4552" class="Bound">x≡prps</a>

<a id="4650" class="Keyword">instance</a>
  <a id="4661" href="Ledger.Chain.html#4661" class="Function">_</a> <a id="4663" class="Symbol">=</a> <a id="4665" href="Data.Nat.Properties.html#16387" class="Function">+-0-monoid</a>

<a id="govActionDeposits"></a><a id="4677" href="Ledger.Chain.html#4677" class="Function">govActionDeposits</a> <a id="4695" class="Symbol">:</a> <a id="4697" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="4704" class="Symbol">→</a> <a id="4706" href="Ledger.GovernanceActions.html#1562" class="Datatype">VDeleg</a> <a id="4713" href="Ledger.Prelude.html#2585" class="Function Operator">⇀</a> <a id="4715" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="4720" href="Ledger.Chain.html#4677" class="Function">govActionDeposits</a> <a id="4738" href="Ledger.Chain.html#4738" class="Bound">ls</a> <a id="4741" class="Symbol">=</a>
  <a id="4745" class="Keyword">let</a> <a id="4749" class="Keyword">open</a> <a id="4754" href="Ledger.Ledger.html#826" class="Module">LState</a> <a id="4761" href="Ledger.Chain.html#4738" class="Bound">ls</a><a id="4763" class="Symbol">;</a> <a id="4765" class="Keyword">open</a> <a id="4770" href="Ledger.Deleg.html#2170" class="Module">CertState</a> <a id="4780" href="Ledger.Ledger.html#937" class="Field">certState</a><a id="4789" class="Symbol">;</a> <a id="4791" class="Keyword">open</a> <a id="4796" href="Ledger.Deleg.html#1867" class="Module">PState</a> <a id="4803" href="Ledger.Deleg.html#2224" class="Function">pState</a><a id="4809" class="Symbol">;</a> <a id="4811" class="Keyword">open</a> <a id="4816" href="Ledger.Utxo.html#4757" class="Module">UTxOState</a> <a id="4826" href="Ledger.Ledger.html#876" class="Field">utxoSt</a><a id="4832" class="Symbol">;</a> <a id="4834" class="Keyword">open</a> <a id="4839" href="Ledger.Deleg.html#1587" class="Module">DState</a> <a id="4846" href="Ledger.Deleg.html#2200" class="Function">dState</a>
   <a id="4856" class="Keyword">in</a> <a id="4859" href="Data.List.Base.html#4412" class="Function">foldl</a> <a id="4865" href="Axiom.Set.Map.Dec.html#1962" class="Function Operator">_∪⁺_</a> <a id="4870" href="Axiom.Set.Map.html#2707" class="Function">∅ᵐ</a> <a id="4873" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="4875" href="Ledger.Prelude.html#2277" class="Function">setToList</a> <a id="4885" href="Function.Base.html#1994" class="Function Operator">$</a>
    <a id="4891" href="Axiom.Set.html#7637" class="Function">mapPartial</a>
      <a id="4908" class="Symbol">(λ</a> <a id="4911" class="Keyword">where</a> <a id="4917" class="Symbol">(</a><a id="4918" href="Ledger.Chain.html#4918" class="Bound">gaid</a> <a id="4923" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4925" class="Keyword">record</a> <a id="4932" class="Symbol">{</a> <a id="4934" href="Ledger.Gov.html#883" class="Field">returnAddr</a> <a id="4945" class="Symbol">=</a> <a id="4947" class="Keyword">record</a> <a id="4954" class="Symbol">{</a><a id="4955" href="Ledger.Address.html#1296" class="Field">stake</a> <a id="4961" class="Symbol">=</a> <a id="4963" href="Ledger.Chain.html#4963" class="Bound">c</a><a id="4964" class="Symbol">}</a> <a id="4966" class="Symbol">})</a> <a id="4969" class="Symbol">→</a> <a id="4971" class="Keyword">do</a>
        <a id="4982" href="Ledger.Chain.html#4982" class="Bound">vd</a> <a id="4985" href="Data.Maybe.Base.html#2242" class="Function Operator">←</a> <a id="4987" href="Axiom.Set.Map.html#9960" class="Function">lookupᵐ?</a> <a id="4996" href="Ledger.Deleg.html#1638" class="Function">voteDelegs</a> <a id="5007" href="Ledger.Chain.html#4963" class="Bound">c</a> <a id="5009" class="Symbol">⦃</a> <a id="5011" class="Symbol">_</a> <a id="5013" href="Axiom.Set.html#10378" class="Function Operator">∈?</a> <a id="5016" class="Symbol">_</a> <a id="5018" class="Symbol">⦄</a>
        <a id="5028" href="Ledger.Chain.html#5028" class="Bound">dep</a> <a id="5032" href="Data.Maybe.Base.html#2242" class="Function Operator">←</a> <a id="5034" href="Axiom.Set.Map.html#9960" class="Function">lookupᵐ?</a> <a id="5043" href="Ledger.Utxo.html#4864" class="Function">deposits</a> <a id="5052" class="Symbol">(</a><a id="5053" href="Ledger.Utxo.html#2616" class="InductiveConstructor">GovActionDeposit</a> <a id="5070" href="Ledger.Chain.html#4918" class="Bound">gaid</a><a id="5074" class="Symbol">)</a> <a id="5076" class="Symbol">⦃</a> <a id="5078" class="Symbol">_</a> <a id="5080" href="Axiom.Set.html#10378" class="Function Operator">∈?</a> <a id="5083" class="Symbol">_</a> <a id="5085" class="Symbol">⦄</a>
        <a id="5095" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="5100" href="Axiom.Set.Map.html#4471" class="Function Operator">❴</a> <a id="5102" href="Ledger.Chain.html#4982" class="Bound">vd</a> <a id="5105" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="5107" href="Ledger.Chain.html#5028" class="Bound">dep</a> <a id="5111" href="Axiom.Set.Map.html#4471" class="Function Operator">❵ᵐ</a> <a id="5114" class="Symbol">)</a>
      <a id="5122" class="Symbol">(</a><a id="5123" href="Ledger.Prelude.html#2334" class="Function">setFromList</a> <a id="5135" href="Ledger.Ledger.html#907" class="Field">govSt</a><a id="5140" class="Symbol">)</a>

<a id="calculateStakeDistrs"></a><a id="5143" href="Ledger.Chain.html#5143" class="Function">calculateStakeDistrs</a> <a id="5164" class="Symbol">:</a> <a id="5166" href="Ledger.Ledger.html#826" class="Record">LState</a> <a id="5173" class="Symbol">→</a> <a id="5175" href="Ledger.Ratify.html#4924" class="Record">StakeDistrs</a>
<a id="5187" href="Ledger.Chain.html#5143" class="Function">calculateStakeDistrs</a> <a id="5208" href="Ledger.Chain.html#5208" class="Bound">ls</a> <a id="5211" class="Symbol">=</a>
  <a id="5215" class="Keyword">let</a> <a id="5219" class="Keyword">open</a> <a id="5224" href="Ledger.Ledger.html#826" class="Module">LState</a> <a id="5231" href="Ledger.Chain.html#5208" class="Bound">ls</a><a id="5233" class="Symbol">;</a> <a id="5235" class="Keyword">open</a> <a id="5240" href="Ledger.Deleg.html#2170" class="Module">CertState</a> <a id="5250" href="Ledger.Ledger.html#937" class="Field">certState</a><a id="5259" class="Symbol">;</a> <a id="5261" class="Keyword">open</a> <a id="5266" href="Ledger.Deleg.html#1867" class="Module">PState</a> <a id="5273" href="Ledger.Deleg.html#2224" class="Function">pState</a><a id="5279" class="Symbol">;</a> <a id="5281" class="Keyword">open</a> <a id="5286" href="Ledger.Utxo.html#4757" class="Module">UTxOState</a> <a id="5296" href="Ledger.Ledger.html#876" class="Field">utxoSt</a><a id="5302" class="Symbol">;</a> <a id="5304" class="Keyword">open</a> <a id="5309" href="Ledger.Deleg.html#1587" class="Module">DState</a> <a id="5316" href="Ledger.Deleg.html#2200" class="Function">dState</a>
      <a id="5329" href="Ledger.Chain.html#5329" class="Bound">spoDelegs</a> <a id="5339" class="Symbol">=</a> <a id="5341" href="Axiom.Set.Map.html#2707" class="Function">∅ᵐ</a> <a id="5344" class="Comment">-- TODO</a>
      <a id="5358" href="Ledger.Chain.html#5358" class="Bound">drepDelegs</a> <a id="5369" class="Symbol">=</a> <a id="5371" href="Axiom.Set.Map.html#2707" class="Function">∅ᵐ</a> <a id="5374" class="Comment">-- TODO</a>
  <a id="5384" class="Keyword">in</a>
  <a id="5389" class="Keyword">record</a>
    <a id="5400" class="Symbol">{</a> <a id="5402" href="Ledger.Ratify.html#4956" class="Field">stakeDistr</a> <a id="5413" class="Symbol">=</a> <a id="5415" href="Ledger.Chain.html#4677" class="Function">govActionDeposits</a> <a id="5433" href="Ledger.Chain.html#5208" class="Bound">ls</a>
    <a id="5440" class="Symbol">}</a>


<a id="5444" class="Keyword">data</a>
<a id="5449" class="Markup">\end{code}</a><a id="5459" class="Background">
\begin{figure*}[h]
</a><a id="5479" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,CHAIN⦈_"></a><a id="5494" href="Ledger.Chain.html#5494" class="Datatype Operator">_⊢_⇀⦇_,CHAIN⦈_</a> <a id="5509" class="Symbol">:</a> <a id="5511" href="Agda.Builtin.Unit.html#158" class="Record">⊤</a> <a id="5513" class="Symbol">→</a> <a id="5515" href="Ledger.Chain.html#982" class="Record">ChainState</a> <a id="5526" class="Symbol">→</a> <a id="5528" href="Ledger.Chain.html#1052" class="Record">Block</a> <a id="5534" class="Symbol">→</a> <a id="5536" href="Ledger.Chain.html#982" class="Record">ChainState</a> <a id="5547" class="Symbol">→</a> <a id="5549" href="Agda.Primitive.html#320" class="Primitive">Set</a>
<a id="5553" class="Markup">\end{code}</a><a id="5563" class="Background">
\caption{Type of the CHAIN transition system}
\end{figure*}
</a><a id="5624" class="Markup">\begin{code}[hide]</a>
  <a id="5645" class="Keyword">where</a>
<a id="5651" class="Markup">\end{code}</a><a id="5661" class="Background">
\begin{figure*}[h]
</a><a id="5681" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,CHAIN⦈_.CHAIN"></a><a id="5696" href="Ledger.Chain.html#5696" class="InductiveConstructor">CHAIN</a> <a id="5702" class="Symbol">:</a>
    <a id="5708" class="Keyword">let</a> <a id="5712" class="Keyword">open</a> <a id="5717" href="Ledger.Chain.html#982" class="Module">ChainState</a> <a id="5728" href="Ledger.Chain.html#1273" class="Generalizable">s</a><a id="5729" class="Symbol">;</a> <a id="5731" class="Keyword">open</a> <a id="5736" href="Ledger.Chain.html#1052" class="Module">Block</a> <a id="5742" href="Ledger.Chain.html#1290" class="Generalizable">b</a><a id="5743" class="Symbol">;</a> <a id="5745" class="Keyword">open</a> <a id="5750" href="Ledger.Chain.html#807" class="Module">NewEpochState</a>
        <a id="5772" href="Ledger.Chain.html#5772" class="Bound">stakeDistrs</a> <a id="5784" class="Symbol">=</a> <a id="5786" href="Ledger.Chain.html#5143" class="Function">calculateStakeDistrs</a> <a id="5807" class="Symbol">(</a><a id="5808" href="Ledger.Chain.html#922" class="Field">ls</a> <a id="5811" href="Ledger.Chain.html#1367" class="Generalizable">nes</a><a id="5814" class="Symbol">)</a>
    <a id="5820" class="Keyword">in</a>
    <a id="5827" class="Keyword">record</a> <a id="5834" class="Symbol">{</a> <a id="5836" href="Ledger.Chain.html#730" class="Field">stakeDistrs</a> <a id="5848" class="Symbol">=</a> <a id="5850" href="Ledger.Chain.html#5772" class="Bound">stakeDistrs</a> <a id="5862" class="Symbol">}</a> <a id="5864" href="Ledger.Chain.html#1641" class="Datatype Operator">⊢</a> <a id="5866" href="Ledger.Chain.html#1013" class="Function">newEpochState</a> <a id="5880" href="Ledger.Chain.html#1641" class="Datatype Operator">⇀⦇</a> <a id="5883" href="Ledger.Epoch.html#647" class="Function">epoch</a> <a id="5889" href="Ledger.Chain.html#1102" class="Function">slot</a> <a id="5894" href="Ledger.Chain.html#1641" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="5905" href="Ledger.Chain.html#1367" class="Generalizable">nes</a>
    <a id="5913" class="Symbol">→</a> <a id="5915" href="Ledger.Ledger.html#759" class="InductiveConstructor Operator">⟦</a> <a id="5917" href="Ledger.Chain.html#1102" class="Function">slot</a> <a id="5922" href="Ledger.Ledger.html#759" class="InductiveConstructor Operator">,</a> <a id="5924" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="5930" class="Symbol">(</a><a id="5931" href="Ledger.GovernanceActions.html#13517" class="Field">EnactState.pparams</a> <a id="5950" class="Symbol">(</a><a id="5951" href="Ledger.Chain.html#950" class="Field">es</a> <a id="5954" href="Ledger.Chain.html#1367" class="Generalizable">nes</a><a id="5957" class="Symbol">))</a> <a id="5960" href="Ledger.Ledger.html#759" class="InductiveConstructor Operator">⟧ˡᵉ</a> <a id="5964" href="Ledger.Ledger.html#2172" class="Function Operator">⊢</a> <a id="5966" href="Ledger.Chain.html#922" class="Field">ls</a> <a id="5969" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="5973" href="Ledger.Ledger.html#2172" class="Function Operator">⇀⦇</a> <a id="5976" href="Ledger.Chain.html#1078" class="Function">ts</a> <a id="5979" href="Ledger.Ledger.html#2172" class="Function Operator">,LEDGERS⦈</a> <a id="5989" href="Ledger.Chain.html#1302" class="Generalizable">ls&#39;</a>
    <a id="5997" href="Interface.STS.html#211" class="Function Operator">────────────────────────────────</a>
    <a id="6034" class="Symbol">_</a> <a id="6036" href="Ledger.Chain.html#5494" class="Datatype Operator">⊢</a> <a id="6038" href="Ledger.Chain.html#1273" class="Generalizable">s</a> <a id="6040" href="Ledger.Chain.html#5494" class="Datatype Operator">⇀⦇</a> <a id="6043" href="Ledger.Chain.html#1290" class="Generalizable">b</a> <a id="6045" href="Ledger.Chain.html#5494" class="Datatype Operator">,CHAIN⦈</a> <a id="6053" class="Keyword">record</a> <a id="6060" href="Ledger.Chain.html#1273" class="Generalizable">s</a> <a id="6062" class="Symbol">{</a> <a id="6064" href="Ledger.Chain.html#1013" class="Field">newEpochState</a> <a id="6078" class="Symbol">=</a> <a id="6080" class="Keyword">record</a> <a id="6087" href="Ledger.Chain.html#1367" class="Generalizable">nes</a> <a id="6091" class="Symbol">{</a> <a id="6093" href="Ledger.Chain.html#922" class="Field">ls</a> <a id="6096" class="Symbol">=</a> <a id="6098" href="Ledger.Chain.html#1302" class="Generalizable">ls&#39;</a> <a id="6102" class="Symbol">}</a> <a id="6104" class="Symbol">}</a>
<a id="6106" class="Markup">\end{code}</a><a id="6116" class="Background">
\caption{CHAIN transition system}
\end{figure*}
</a></pre></body></html>